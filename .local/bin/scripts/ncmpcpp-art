#!/bin/sh

if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
    exec ncmpcpp --quiet --config "$XDG_CONFIG_HOME/ncmpcpp/config"
else
    [ ! -d "$XDG_CACHE_HOME/ncmpcpp" ] && mkdir -p "$XDG_CACHE_HOME/ncmpcpp"
    export NCMPCPP_UEBERZUG_FIFO="$XDG_CACHE_HOME/ncmpcpp/ncmpcpp-ueberzug-$$"
    mkfifo "$NCMPCPP_UEBERZUG_FIFO"
    ueberzug layer -s -p json <"$NCMPCPP_UEBERZUG_FIFO" &
    NCMPCPP_UEBERZUG_FIFO_PID=$!
    exec 3>"$NCMPCPP_UEBERZUG_FIFO"
    (
        while kill -0 $$ 2>/dev/null; do
            sleep 0.1
        done
        kill "$NCMPCPP_UEBERZUG_FIFO_PID"
    ) &
    exec ncmpcpp --quiet --config "$XDG_CONFIG_HOME/ncmpcpp/config-art"
fi
