#!/bin/bash

if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
    exec lf "$@"
else
    [ ! -d "$XDG_CACHE_HOME/lf" ] && mkdir -p "$XDG_CACHE_HOME/lf"
    export LF_UEBERZUG_FIFO="$XDG_CACHE_HOME/lf/lf-ueberzug-$$"
    mkfifo "$LF_UEBERZUG_FIFO"
    ueberzug layer -s -p json <"$LF_UEBERZUG_FIFO" &
    LF_UEBERZUG_FIFO_PID=$!
    exec 3>"$LF_UEBERZUG_FIFO"
    [ -f "$XDG_CONFIG_HOME/fzf/fzfrc" ] && source "$XDG_CONFIG_HOME/fzf/fzfrc"
    (
        while kill -0 $$ 2>/dev/null; do
            sleep 0.1
        done
        kill "$LF_UEBERZUG_FIFO_PID"
    ) &
    exec lf "$@"
fi
